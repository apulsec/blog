# åšå®¢å¹³å° - å¾®æœåŠ¡é›†æˆæŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿°äº† blog-user-service å’Œ blog-auth-service çš„å®Œæ•´é›†æˆæ–¹æ¡ˆï¼Œå®ç°äº†ï¼š

- ç”¨æˆ·æ³¨å†Œä¸è®¤è¯åˆ†ç¦»
- OpenFeign è·¨æœåŠ¡è°ƒç”¨
- JWT Token ç”Ÿæˆä¸éªŒè¯
- Redis é»‘åå•æœºåˆ¶

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æœåŠ¡èŒè´£åˆ’åˆ†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å®¢æˆ·ç«¯/å‰ç«¯                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚                         â”‚
                 â–¼                         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ blog-user-service  â”‚    â”‚ blog-auth-service  â”‚
    â”‚   (ç«¯å£ 8083)      â”‚â—„â”€â”€â”€â”‚   (ç«¯å£ 8081)      â”‚
    â”‚                    â”‚    â”‚                    â”‚
    â”‚ èŒè´£:              â”‚    â”‚ èŒè´£:              â”‚
    â”‚ â€¢ ç”¨æˆ·æ³¨å†Œ         â”‚    â”‚ â€¢ ç”¨æˆ·ç™»å½•         â”‚
    â”‚ â€¢ ç”¨æˆ·ä¿¡æ¯ç®¡ç†     â”‚    â”‚ â€¢ JWT ç”Ÿæˆ         â”‚
    â”‚ â€¢ è®¤è¯å‡­è¯å­˜å‚¨     â”‚    â”‚ â€¢ Token éªŒè¯       â”‚
    â”‚                    â”‚    â”‚ â€¢ Token é»‘åå•     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                         â”‚
             â–¼                         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   PostgreSQL    â”‚      â”‚      Redis      â”‚
    â”‚  (ç«¯å£ 15432)   â”‚      â”‚   (ç«¯å£ 6379)   â”‚
    â”‚                 â”‚      â”‚                 â”‚
    â”‚ â€¢ t_user        â”‚      â”‚ â€¢ JWT é»‘åå•    â”‚
    â”‚ â€¢ t_user_auth   â”‚      â”‚                 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è°ƒç”¨æµç¨‹

#### 1ï¸âƒ£ ç”¨æˆ·æ³¨å†Œæµç¨‹

```
å®¢æˆ·ç«¯ â†’ blog-user-service
         â””â”€> éªŒè¯æ•°æ®
         â””â”€> BCrypt åŠ å¯†å¯†ç 
         â””â”€> å­˜å‚¨åˆ° PostgreSQL
         â””â”€> è¿”å›ç”¨æˆ·ä¿¡æ¯
```

#### 2ï¸âƒ£ ç”¨æˆ·ç™»å½•æµç¨‹

```
å®¢æˆ·ç«¯ â†’ blog-auth-service
         â””â”€> [Feign Client] è°ƒç”¨ blog-user-service
                           â””â”€> æŸ¥è¯¢ç”¨æˆ·è®¤è¯ä¿¡æ¯
                           â””â”€> è¿”å›åŠ å¯†å¯†ç 
         â””â”€> BCrypt éªŒè¯å¯†ç 
         â””â”€> ç”Ÿæˆ JWT (Access + Refresh)
         â””â”€> è¿”å› Tokens
```

#### 3ï¸âƒ£ Token éªŒè¯æµç¨‹

```
å®¢æˆ·ç«¯ â†’ blog-auth-service /validate
         â””â”€> éªŒè¯ JWT ç­¾å
         â””â”€> æ£€æŸ¥ Redis é»‘åå•
         â””â”€> è¿”å›ç”¨æˆ·å
```

#### 4ï¸âƒ£ ç”¨æˆ·ç™»å‡ºæµç¨‹

```
å®¢æˆ·ç«¯ â†’ blog-auth-service /logout
         â””â”€> æå– Token JTI
         â””â”€> åŠ å…¥ Redis é»‘åå• (TTL = Token å‰©ä½™æ—¶é—´)
         â””â”€> è¿”å›æˆåŠŸ
```

## ğŸ”§ æŠ€æœ¯å®ç°

### Feign Client é›†æˆ

**UserServiceClient.java**

```java
@FeignClient(
    name = "blog-user-service",
  url = "${user-service.url:}",
    fallback = UserServiceClientFallback.class
)
public interface UserServiceClient {
    @GetMapping("/api/users/internal/auth-details")
    UserAuthDetailsDTO getUserAuthDetails(@RequestParam("identifier") String identifier);
}
```

**é…ç½®æ–‡ä»¶ (application.yml)**

```yaml
user-service:
  url: ${USER_SERVICE_URL:}

feign:
  client:
    config:
      default:
        connectTimeout: 5000
        readTimeout: 5000
        loggerLevel: basic
```

### UserDetailsService é›†æˆ

**ä¿®æ”¹å‰ (Mock å®ç°)**

```java
if ("user".equals(username)) {
    return new User("user", passwordEncoder.encode("password"), new ArrayList<>());
}
```

**ä¿®æ”¹å (Feign è°ƒç”¨)**

```java
UserAuthDetailsDTO authDetails = userServiceClient.getUserAuthDetails(username);
return User.builder()
    .username(authDetails.getIdentifier())
    .password(authDetails.getCredential())  // å·²åŠ å¯†çš„å¯†ç 
    .authorities(new ArrayList<>())
    .disabled(authDetails.getStatus() != 1)
    .build();
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å¯åŠ¨åŸºç¡€è®¾æ–½

```powershell
# Redis
docker run -d --name redis -p 6379:6379 redis:7-alpine

# PostgreSQL (å¦‚æœè¿˜æœªåˆå§‹åŒ–)
cd blog-user-service
.\init-db.ps1
```

### 2. å¯åŠ¨æœåŠ¡

**æ–¹å¼ A: è‡ªåŠ¨å¯åŠ¨æ‰€æœ‰æœåŠ¡**

```powershell
.\start-all-services.ps1
```

**æ–¹å¼ B: æ‰‹åŠ¨é€ä¸ªå¯åŠ¨**

```powershell
# ç»ˆç«¯ 1: å¯åŠ¨ç”¨æˆ·æœåŠ¡
cd blog-user-service
mvn spring-boot:run

# ç»ˆç«¯ 2: å¯åŠ¨è®¤è¯æœåŠ¡
cd blog-auth-service
mvn spring-boot:run
```

### 3. è¿è¡Œé›†æˆæµ‹è¯•

```powershell
.\test-integration.ps1
```

## ğŸ§ª æµ‹è¯•åœºæ™¯

é›†æˆæµ‹è¯•è„šæœ¬éªŒè¯ä»¥ä¸‹æµç¨‹ï¼š

| æ­¥éª¤ | æ“ä½œ       | éªŒè¯ç‚¹               |
| ---- | ---------- | -------------------- |
| 1    | ç”¨æˆ·æ³¨å†Œ   | PostgreSQL å­˜å‚¨æˆåŠŸ  |
| 2    | æŸ¥è¯¢ç”¨æˆ·   | æ•°æ®ä¸€è‡´æ€§           |
| 3    | ç”¨æˆ·ç™»å½•   | Feign è°ƒç”¨ã€JWT ç”Ÿæˆ |
| 4    | Token éªŒè¯ | ç­¾åéªŒè¯é€šè¿‡         |
| 5    | ç”¨æˆ·ç™»å‡º   | Redis é»‘åå•æ·»åŠ      |
| 6    | é»‘åå•éªŒè¯ | Token è¢«æ‹’ç» (401)   |

### é¢„æœŸè¾“å‡º

```
âœ“ ç”¨æˆ·æ³¨å†Œ (PostgreSQL å­˜å‚¨)
âœ“ ç”¨æˆ·æŸ¥è¯¢
âœ“ auth-service è°ƒç”¨ user-service (Feign Client)
âœ“ BCrypt å¯†ç éªŒè¯
âœ“ JWT Token ç”Ÿæˆ
âœ“ JWT Token éªŒè¯
âœ“ Redis é»‘åå•æœºåˆ¶
âœ“ é»‘åå• Token æ‹’ç»
```

## ğŸ“Š æ•°æ®æµ

### æ³¨å†Œæ—¶çš„å¯†ç åŠ å¯†

```
å®¢æˆ·ç«¯å¯†ç  (æ˜æ–‡)
    â†“
blog-user-service (BCrypt åŠ å¯†)
    â†“
PostgreSQL t_user_auth (å­˜å‚¨å“ˆå¸Œ)
```

### ç™»å½•æ—¶çš„å¯†ç éªŒè¯

```
å®¢æˆ·ç«¯å¯†ç  (æ˜æ–‡)
    â†“
blog-auth-service
    â†“
Feign â†’ blog-user-service (è·å–å“ˆå¸Œå¯†ç )
    â†“
Spring Security (BCrypt.matches)
    â†“
JWT ç”Ÿæˆ
```

## ğŸ” å®‰å…¨ç‰¹æ€§

### 1. å¯†ç å®‰å…¨

- âœ… BCrypt åŠ å¯† (é»˜è®¤ 10 è½®)
- âœ… å¯†ç æ˜æ–‡æ°¸ä¸å­˜å‚¨
- âœ… å¯†ç æ°¸ä¸é€šè¿‡ç½‘ç»œä¼ è¾“ï¼ˆé™¤åˆå§‹æ³¨å†Œ/ç™»å½•ï¼‰

### 2. Token å®‰å…¨

- âœ… JWT ä½¿ç”¨ HMAC-SHA256 ç­¾å
- âœ… Access Token: 1 å°æ—¶è¿‡æœŸ
- âœ… Refresh Token: 7 å¤©è¿‡æœŸ
- âœ… ç™»å‡ºåç«‹å³å¤±æ•ˆ (Redis é»‘åå•)

### 3. æœåŠ¡é—´é€šä¿¡

- âœ… å†…éƒ¨æ¥å£ `/internal/*` åº”é…ç½®ç½‘å…³æ‹¦æˆª
- âœ… Feign è¶…æ—¶é…ç½® (5 ç§’)
- âœ… é™çº§å¤„ç† (UserServiceClientFallback)

## ğŸ“ API ç«¯ç‚¹

### blog-user-service (8083)

| ç«¯ç‚¹                               | æ–¹æ³• | è¯´æ˜                |
| ---------------------------------- | ---- | ------------------- |
| `/api/users/register`              | POST | ç”¨æˆ·æ³¨å†Œ            |
| `/api/users/{id}`                  | GET  | è·å–ç”¨æˆ·ä¿¡æ¯        |
| `/api/users/internal/auth-details` | GET  | è·å–è®¤è¯è¯¦æƒ… (å†…éƒ¨) |

### blog-auth-service (8081)

| ç«¯ç‚¹                 | æ–¹æ³• | è¯´æ˜       |
| -------------------- | ---- | ---------- |
| `/api/auth/login`    | POST | ç”¨æˆ·ç™»å½•   |
| `/api/auth/logout`   | POST | ç”¨æˆ·ç™»å‡º   |
| `/api/auth/refresh`  | POST | åˆ·æ–° Token |
| `/api/auth/validate` | GET  | éªŒè¯ Token |

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: Feign è°ƒç”¨å¤±è´¥

**ç—‡çŠ¶**: `Connection refused` æˆ–è¶…æ—¶

**è§£å†³æ–¹æ¡ˆ**:

1. æ£€æŸ¥ user-service æ˜¯å¦å¯åŠ¨: `curl http://localhost:8083/actuator/health`
2. æ£€æŸ¥ç½‘ç»œè¿æ¥
3. æŸ¥çœ‹ auth-service æ—¥å¿—ä¸­çš„ Feign é”™è¯¯

### é—®é¢˜ 2: ç™»å½•è¿”å› 401

**ç—‡çŠ¶**: è®¤è¯å¤±è´¥

**å¯èƒ½åŸå› **:

- ç”¨æˆ·æœªæ³¨å†Œ
- å¯†ç é”™è¯¯
- ç”¨æˆ·çŠ¶æ€ä¸º 0 (inactive)

**è°ƒè¯•æ­¥éª¤**:

```powershell
# æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
curl http://localhost:8083/api/users/internal/auth-details?identifier=test@example.com

# æŸ¥çœ‹è®¤è¯æœåŠ¡æ—¥å¿—
# åº”è¯¥çœ‹åˆ° "Loading user details for username: xxx"
```

### é—®é¢˜ 3: Token éªŒè¯å¤±è´¥

**ç—‡çŠ¶**: `/validate` è¿”å› 401

**å¯èƒ½åŸå› **:

- Token å·²è¿‡æœŸ
- Token åœ¨é»‘åå•ä¸­
- JWT ç­¾åä¸åŒ¹é…

**è°ƒè¯•**:

```powershell
# æ£€æŸ¥ Redis é»‘åå•
docker exec -it redis redis-cli
> KEYS jwt:blacklist:*
> GET jwt:blacklist:<jti>
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. Redis è¿æ¥æ± 

```yaml
spring:
  data:
    redis:
      lettuce:
        pool:
          max-active: 8
          max-idle: 8
          min-idle: 2
```

### 2. Feign è¿æ¥æ± 

```xml
<dependency>
    <groupId>io.github.openfeign</groupId>
    <artifactId>feign-httpclient</artifactId>
</dependency>
```

### 3. æ•°æ®åº“è¿æ¥æ± 

```yaml
spring:
  datasource:
    hikari:
      maximum-pool-size: 10
      minimum-idle: 5
```

## ğŸ”„ æœªæ¥æ‰©å±•

- [x] æ·»åŠ æœåŠ¡å‘ç° (Eureka)
- [ ] é›†æˆ API Gateway
- [ ] æ·»åŠ åˆ†å¸ƒå¼è¿½è¸ª (Zipkin)
- [ ] å®ç° OAuth2 ç¬¬ä¸‰æ–¹ç™»å½•
- [ ] æ·»åŠ ç”¨æˆ·æƒé™ç®¡ç† (RBAC)

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [blog-user-service README](blog-user-service/README.md)
- [blog-auth-service README](blog-auth-service/README.md)
- [é¡¹ç›®åˆ†ææŠ¥å‘Š](project-analysis-report.md)

## âœ… æ€»ç»“

é€šè¿‡ OpenFeign é›†æˆï¼Œå®ç°äº†ï¼š

1. âœ… æœåŠ¡èŒè´£åˆ†ç¦»ï¼ˆç”¨æˆ·ç®¡ç† vs è®¤è¯æˆæƒï¼‰
2. âœ… è·¨æœåŠ¡é€šä¿¡ï¼ˆå£°æ˜å¼ REST å®¢æˆ·ç«¯ï¼‰
3. âœ… ç»Ÿä¸€å¯†ç åŠ å¯†ï¼ˆBCryptï¼‰
4. âœ… JWT ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆç”Ÿæˆã€éªŒè¯ã€æ’¤é”€ï¼‰
5. âœ… Redis é»‘åå•æœºåˆ¶
6. âœ… å®Œæ•´çš„ç«¯åˆ°ç«¯æµ‹è¯•

ç°åœ¨ä¸¤ä¸ªæœåŠ¡å·²å®Œç¾é›†æˆï¼Œå¯ä»¥æ”¯æ’‘å®Œæ•´çš„ç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€è®¤è¯æµç¨‹ï¼
