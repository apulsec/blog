# 本地环境搭建手册

本文档面向第一天加入项目的同学，按照顺序完成所有步骤即可在本地运行完整的博客平台（前端 + 三个后端微服务）。所有命令均以 Windows PowerShell (`pwsh`) 为例，若使用其他终端请自行调整路径与语法。

## 1. 目标概览

- 前端：`blog-frontend`（Vite + Vue 3 + Pinia）。
- 后端：`blog-user-service`、`blog-auth-service`、`blog-article-service`（Spring Boot 3.2 + JDK 17）。
- 基础设施：PostgreSQL、MongoDB、Redis（通过 Docker 启动）。

## 2. 本地必备环境

在继续之前请确保以下组件已经安装并可用：

- Windows 10 21H2 或 Windows 11（64 位），启用了 WSL2（Docker Desktop 依赖）。
- Git ≥ 2.30：`git --version`
- Docker Desktop ≥ 4.27：`docker version`
- Node.js 18 LTS（附带 npm）：`node --version`、`npm --version`
- JDK 17（推荐 Eclipse Temurin）：`java -version`
- Apache Maven ≥ 3.9：`mvn -v`
- PowerShell 7（推荐，方便运行脚本）：`pwsh -v`

> 若任一命令返回“未找到”，请先安装并将其加入 `PATH`。

## 3. 获取项目源码

如尚未克隆仓库，可执行以下命令（将 `YOUR_REMOTE_URL` 替换为团队仓库地址）：

```powershell
cd ~\Desktop
git clone YOUR_REMOTE_URL blog
cd blog
```

> 如果已经在正确的仓库目录（`c:\Users\lenovo\Desktop\blog`），可直接跳过本节。

## 4. 使用 Docker 启动基础设施

1. 确认 Docker Desktop 处于 Running 状态。
2. 在项目根目录（`blog`）创建 `docker-compose.yml` 文件（若已存在可跳过），内容如下：

```yaml
version: "3.8"

services:
  postgres:
    image: postgres:14-alpine
    container_name: blog-postgres
    environment:
      POSTGRES_DB: blog_article_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    ports:
      - "15432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - blog-network

  mongo:
    image: mongo:7.0
    container_name: blog-mongo
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: password
      MONGO_INITDB_DATABASE: blog_content_db
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
    networks:
      - blog-network

  redis:
    image: redis:7-alpine
    container_name: blog-redis
    ports:
      - "6379:6379"
    networks:
      - blog-network

volumes:
  postgres_data:
  mongo_data:

networks:
  blog-network:
    driver: bridge
```

3. 启动所有依赖容器：

```powershell
docker compose up -d
```

4. 验证容器状态：

```powershell
docker compose ps
docker exec -it blog-postgres psql -U postgres -c "SELECT version();"
docker exec -it blog-mongo mongosh --eval "db.runCommand({ ping: 1 })"
docker exec -it blog-redis redis-cli ping
```

当上述命令均返回成功结果时，基础设施已就绪。

## 5. 初始化数据库

> 运行以下脚本前请确保第 4 节的容器均已启动。

### 5.1 初始化文章服务数据

```powershell
Set-Location c:\Users\lenovo\Desktop\blog
.\blog-article-service\init-db-docker.ps1
```

若需补充点赞 / 评论相关表，可执行：

```powershell
Get-Content .\blog-article-service\add-likes-and-comments-tables.sql |
  docker exec -i blog-postgres psql -U postgres -d blog_article_db
```

### 5.2 初始化用户服务数据

```powershell
Set-Location c:\Users\lenovo\Desktop\blog
.\blog-user-service\init-db.ps1
```

> 该脚本会自动创建 `blog_user_db` 并生成 `t_user`、`t_user_auth` 等表结构。

### 5.3 检查结果

```powershell
docker exec -it blog-postgres psql -U postgres -c "\l"
docker exec -it blog-postgres psql -U postgres -d blog_article_db -c "\dt"
docker exec -it blog-postgres psql -U postgres -d blog_user_db -c "\dt"
```

## 6. 启动后端微服务

建议按照“用户服务 → 认证服务 → 文章服务”的顺序在独立终端启动，确保依赖关系完整。

### 6.1 blog-user-service（端口 8083）

```powershell
Set-Location c:\Users\lenovo\Desktop\blog\blog-user-service
mvn clean package -DskipTests
mvn spring-boot:run
```

服务正常启动后可通过 `http://localhost:8083/actuator/health` 检查健康状态。

### 6.2 blog-auth-service（端口 8081）

```powershell
Set-Location c:\Users\lenovo\Desktop\blog\blog-auth-service
mvn clean package -DskipTests
mvn spring-boot:run
```

认证服务依赖 Redis，请确认 `blog-redis` 容器保持运行。

### 6.3 blog-article-service（端口 8082）

```powershell
Set-Location c:\Users\lenovo\Desktop\blog\blog-article-service
mvn clean package -DskipTests
mvn spring-boot:run
```

文章服务依赖 PostgreSQL、MongoDB 以及用户服务。若第一次启动失败，可检查上述依赖是否全部可连接。

## 7. 启动前端应用

1. 安装依赖：

```powershell
Set-Location c:\Users\lenovo\Desktop\blog\blog-frontend
npm install
```

2. 启动开发服务器：

```powershell
npm run dev -- --host
```

3. 打开浏览器访问 `http://localhost:5173`，即可看到博客前端界面。

> 代理配置已在 `vite.config.js` 中写好，会自动把 `/api/*` 请求转发到对应的后端服务端口。

## 8. 验证整体链路

- 用户注册：在前端注册一个账号，同时关注 `blog-user-service` 控制台是否有请求日志。
- 登录：完成登录后检查浏览器 `localStorage` 是否写入 `access_token`、`refresh_token`。
- 创建文章：在“写文章”页面提交内容，确认 `blog-article-service` 控制台显示保存日志，并在列表页看到新文章。
- 点赞 / 评论：在文章详情页执行一次点赞或评论，观察文章服务、用户服务是否都收到通知请求。
- 健康检查：

```powershell
Invoke-WebRequest http://localhost:8083/actuator/health
Invoke-WebRequest http://localhost:8081/actuator/health
Invoke-WebRequest http://localhost:8082/actuator/health
```

若返回 `"status":"UP"`，说明对应服务运行正常。

## 9. 常见问题与排查

- **端口占用**：若 `8081/8082/8083/5173` 已被其他程序使用，请先释放端口或在 `application.yml`/`vite.config.js` 中调整端口并保持前端代理同步更新。
- **Docker 网络异常**：执行 `docker compose ps` 查看容器状态，若有 `Exited`，使用 `docker compose logs <容器名>` 查看错误。
- **数据库连接失败**：确认 PostgreSQL、MongoDB、Redis 容器均在运行，并与配置中的默认凭据（用户名 `postgres` / `root`，密码 `password`）一致。
- **Maven 下载缓慢**：可配置公司内部 Maven 仓库，或在个人 `~/.m2/settings.xml` 中添加镜像。
- **前端依赖安装失败**：检查 Node 版本是否为 18 LTS；国内网络可考虑使用 `npm config set registry https://registry.npmmirror.com`。

## 10. 后续任务

- 运行现有测试脚本：项目根目录提供了 `test-article-list.ps1`、`test-notifications.ps1` 等脚本，可在各服务启动后执行以做端到端冒烟测试。
- 构建产物：
  - 后端：`mvn clean package`
  - 前端：`npm run build`
- 如需重置开发环境，可执行 `docker compose down -v` 清理容器与数据卷，再重新按照本文档初始化。
